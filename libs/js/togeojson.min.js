var toGeoJSON=(function(){var s=/\s*/g,g=/^\s*|\s*$/g,h=/\s+/;function o(t){if(!t||!t.length){return 0}for(var y=0,z=0;y<t.length;y++){z=((z<<5)-z)+t.charCodeAt(y)|0}return z}function u(t,z){return t.getElementsByTagName(z)}function m(t,z){return t.getAttribute(z)}function v(t,z){return parseFloat(m(t,z))}function k(t,A){var z=u(t,A);return z.length?z[0]:null}function e(t){if(t.normalize){t.normalize()}return t}function a(t){for(var y=0,z=[];y<t.length;y++){z[y]=parseFloat(t[y])}return z}function b(t){if(t){e(t)}return(t&&t.textContent)||""}function c(t,z){var A={},B,y;for(y=0;y<z.length;y++){B=k(t,z[y]);if(B){A[z[y]]=b(B)}}return A}function q(t,A){for(var z in A){t[z]=A[z]}}function d(t){return a(t.replace(s,"").split(","))}function n(t){var y=t.replace(g,"").split(h),z=[];for(var x=0;x<y.length;x++){z.push(d(y[x]))}return z}function w(t){var C=[v(t,"lon"),v(t,"lat")],z=k(t,"ele"),y=k(t,"gpxtpx:hr")||k(t,"hr"),B=k(t,"time"),A;if(z){A=parseFloat(b(z));if(!isNaN(A)){C.push(A)}}return{coordinates:C,time:B?b(B):null,heartRate:y?parseFloat(b(y)):null}}function j(){return{type:"FeatureCollection",features:[]}}var p;if(typeof XMLSerializer!=="undefined"){p=new XMLSerializer()}else{var r=(typeof process==="object"&&!process.browser);var l=(typeof Titanium==="object");if(typeof exports==="object"&&(r||l)){p=new (require("xmldom").XMLSerializer)()}else{throw new Error("Unable to initialize serializer")}}function f(t){if(t.xml!==undefined){return t.xml}return p.serializeToString(t)}var i={kml:function(P){var N=j(),A={},O={},G={},t=["Polygon","LineString","Point","Track","gx:Track"],E=u(P,"Placemark"),D=u(P,"Style"),M=u(P,"StyleMap");for(var K=0;K<D.length;K++){var x=o(f(D[K])).toString(16);A["#"+m(D[K],"id")]=x;O[x]=D[K]}for(var I=0;I<M.length;I++){A["#"+m(M[I],"id")]=o(f(M[I])).toString(16);var Q=u(M[I],"Pair");var J={};for(var H=0;H<Q.length;H++){J[b(k(Q[H],"key"))]=b(k(Q[H],"styleUrl"))}G["#"+m(M[I],"id")]=J}for(var L=0;L<E.length;L++){N.features=N.features.concat(z(E[L]))}function y(S){var R,T;S=S||"";if(S.substr(0,1)==="#"){S=S.substr(1)}if(S.length===6||S.length===3){R=S}if(S.length===8){T=parseInt(S.substr(0,2),16)/255;R="#"+S.substr(6,2)+S.substr(4,2)+S.substr(2,2)}return[R,isNaN(T)?undefined:T]}function F(R){return a(R.split(" "))}function C(S){var T=u(S,"coord","gx"),W=[],X=[];if(T.length===0){T=u(S,"gx:coord")}for(var V=0;V<T.length;V++){W.push(F(b(T[V])))}var R=u(S,"when");for(var U=0;U<R.length;U++){X.push(b(R[U]))}return{coords:W,times:X}}function B(X){var V,aa,W,U,T,ab=[],S=[];if(k(X,"MultiGeometry")){return B(k(X,"MultiGeometry"))}if(k(X,"MultiTrack")){return B(k(X,"MultiTrack"))}if(k(X,"gx:MultiTrack")){return B(k(X,"gx:MultiTrack"))}for(W=0;W<t.length;W++){aa=u(X,t[W]);if(aa){for(U=0;U<aa.length;U++){V=aa[U];if(t[W]==="Point"){ab.push({type:"Point",coordinates:d(b(k(V,"coordinates")))})}else{if(t[W]==="LineString"){ab.push({type:"LineString",coordinates:n(b(k(V,"coordinates")))})}else{if(t[W]==="Polygon"){var Z=u(V,"LinearRing"),Y=[];for(T=0;T<Z.length;T++){Y.push(n(b(k(Z[T],"coordinates"))))}ab.push({type:"Polygon",coordinates:Y})}else{if(t[W]==="Track"||t[W]==="gx:Track"){var R=C(V);ab.push({type:"LineString",coordinates:R.coords});if(R.times.length){S.push(R.times)}}}}}}}}return{geoms:ab,coordTimes:S}}function z(aj){var S=B(aj),ao,ac={},ax=b(k(aj,"name")),W=b(k(aj,"address")),R=b(k(aj,"styleUrl")),am=b(k(aj,"description")),ar=k(aj,"TimeSpan"),ad=k(aj,"TimeStamp"),ag=k(aj,"ExtendedData"),T=k(aj,"LineStyle"),Y=k(aj,"PolyStyle"),ap=k(aj,"visibility");if(!S.geoms.length){return[]}if(ax){ac.name=ax}if(W){ac.address=W}if(R){if(R[0]!=="#"){R="#"+R}ac.styleUrl=R;if(A[R]){ac.styleHash=A[R]}if(G[R]){ac.styleMapHash=G[R];ac.styleHash=A[G[R].normal]}var aq=O[ac.styleHash];if(aq){if(!T){T=k(aq,"LineStyle")}if(!Y){Y=k(aq,"PolyStyle")}var ab=k(aq,"IconStyle");if(ab){var au=k(ab,"Icon");if(au){var an=b(k(au,"href"));if(an){ac.icon=an}}}}}if(am){ac.description=am}if(ar){var aw=b(k(ar,"begin"));var V=b(k(ar,"end"));ac.timespan={begin:aw,end:V}}if(ad){ac.timestamp=b(k(ad,"when"))}if(T){var af=y(b(k(T,"color"))),ak=af[0],U=af[1],ai=parseFloat(b(k(T,"width")));if(ak){ac.stroke=ak}if(!isNaN(U)){ac["stroke-opacity"]=U}if(!isNaN(ai)){ac["stroke-width"]=ai}}if(Y){var X=y(b(k(Y,"color"))),ae=X[0],ah=X[1],al=b(k(Y,"fill")),Z=b(k(Y,"outline"));if(ae){ac.fill=ae}if(!isNaN(ah)){ac["fill-opacity"]=ah}if(al){ac["fill-opacity"]=al==="1"?ac["fill-opacity"]||1:0}if(Z){ac["stroke-opacity"]=Z==="1"?ac["stroke-opacity"]||1:0}}if(ag){var av=u(ag,"Data"),at=u(ag,"SimpleData");for(ao=0;ao<av.length;ao++){ac[av[ao].getAttribute("name")]=b(k(av[ao],"value"))}for(ao=0;ao<at.length;ao++){ac[at[ao].getAttribute("name")]=b(at[ao])}}if(ap){ac.visibility=b(ap)}if(S.coordTimes.length){ac.coordTimes=(S.coordTimes.length===1)?S.coordTimes[0]:S.coordTimes}var aa={type:"Feature",geometry:(S.geoms.length===1)?S.geoms[0]:{type:"GeometryCollection",geometries:S.geoms},properties:ac};if(m(aj,"id")){aa.id=m(aj,"id")}return[aa]}return N},gpx:function(H){var B,D=u(H,"trk"),I=u(H,"rte"),E=u(H,"wpt"),C=j(),J;for(B=0;B<D.length;B++){J=G(D[B]);if(J){C.features.push(J)}}for(B=0;B<I.length;B++){J=z(I[B]);if(J){C.features.push(J)}}for(B=0;B<E.length;B++){C.features.push(y(E[B]))}function F(K,L){for(var M=0;M<L;M++){K.push(null)}return K}function A(M,L){var R=u(M,L),S=[],K=[],Q=[],N=R.length;if(N<2){return{}}for(var O=0;O<N;O++){var P=w(R[O]);S.push(P.coordinates);if(P.time){K.push(P.time)}if(P.heartRate||Q.length){if(!Q.length){F(Q,O)}Q.push(P.heartRate||null)}}return{line:S,times:K,heartRates:Q}}function G(M){var O=u(M,"trkseg"),L=[],K=[],Q=[],S;for(var N=0;N<O.length;N++){S=A(O[N],"trkpt");if(S){if(S.line){L.push(S.line)}if(S.times&&S.times.length){K.push(S.times)}if(Q.length||(S.heartRates&&S.heartRates.length)){if(!Q.length){for(var R=0;R<N;R++){Q.push(F([],L[R].length))}}if(S.heartRates&&S.heartRates.length){Q.push(S.heartRates)}else{Q.push(F([],S.line.length||0))}}}}if(L.length===0){return}var P=x(M);q(P,t(k(M,"extensions")));if(K.length){P.coordTimes=L.length===1?K[0]:K}if(Q.length){P.heartRates=L.length===1?Q[0]:Q}return{type:"Feature",properties:P,geometry:{type:L.length===1?"LineString":"MultiLineString",coordinates:L.length===1?L[0]:L}}}function z(M){var K=A(M,"rtept");if(!K.line){return}var N=x(M);q(N,t(k(M,"extensions")));var L={type:"Feature",properties:N,geometry:{type:"LineString",coordinates:K.line}};return L}function y(K){var L=x(K);q(L,c(K,["sym"]));return{type:"Feature",properties:L,geometry:{type:"Point",coordinates:w(K).coordinates}}}function t(P){var O={};if(P){var K=k(P,"line");if(K){var L=b(k(K,"color")),M=parseFloat(b(k(K,"opacity"))),N=parseFloat(b(k(K,"width")));if(L){O.stroke=L}if(!isNaN(M)){O["stroke-opacity"]=M}if(!isNaN(N)){O["stroke-width"]=N*96/25.4}}}return O}function x(N){var O=c(N,["name","cmt","desc","type","time","keywords"]),K=u(N,"link");if(K.length){O.links=[]}for(var L=0,M;L<K.length;L++){M={href:m(K[L],"href")};q(M,c(K[L],["text","type"]));O.links.push(M)}return O}return C}};return i})();if(typeof module!=="undefined"){module.exports=toGeoJSON};