<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />

    <!-- This is the Waymark Logo in SVG format -->
    <link
      rel="icon"
      href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 368 368'%3E%3Cg transform='translate(0,368) scale(0.1,-0.1)'%0Afill='%23b42714'%3E%3Cpath d='M343 3186 c-89 -29 -178 -108 -215 -194 -80 -181 21 -408 208 -468%0Al51 -17 238 -781 c131 -430 241 -787 243 -793 3 -10 -21 -13 -99 -14 -57 0%0A-126 -4 -152 -7 l-48 -7 298 -217 c163 -119 299 -216 300 -214 6 6 252 690%0A249 693 -1 2 -59 -33 -129 -77 -70 -43 -128 -76 -130 -72 -2 4 -111 359 -242%0A790 l-239 782 32 33 c17 17 43 59 59 92 23 50 27 74 28 140 0 71 -4 88 -33%0A147 -37 75 -96 133 -170 169 -58 28 -186 36 -249 15z'/%3E%3Cpath d='M1580 2987 l-294 -212 64 -6 c36 -4 105 -7 153 -8 87 -1 88 -1 81%0A-23 -3 -13 -74 -236 -156 -496 l-150 -473 55 -199 c30 -110 62 -206 70 -215%0A19 -18 41 -19 54 -2 5 6 101 303 214 659 112 356 207 648 210 648 3 0 57 -33%0A120 -73 63 -40 120 -76 126 -81 7 -4 -17 78 -53 181 -36 103 -91 261 -122 351%0A-31 89 -61 162 -67 161 -5 0 -143 -96 -305 -212z'/%3E%3Cpath d='M3040 2987 l-294 -212 64 -6 c36 -4 105 -7 153 -8 87 -1 88 -1 81%0A-23 -3 -13 -74 -236 -156 -496 l-150 -473 55 -199 c30 -110 62 -206 70 -215%0A19 -18 41 -19 54 -2 5 6 101 303 214 659 112 356 207 648 210 648 3 0 57 -33%0A120 -73 63 -40 120 -76 126 -81 7 -4 -17 78 -53 181 -36 103 -91 261 -122 351%0A-31 89 -61 162 -67 161 -5 0 -143 -96 -305 -212z'/%3E%3Cpath d='M2161 2342 c-14 -11 -40 -80 -81 -207 -33 -104 -60 -197 -60 -205 0%0A-8 61 -235 135 -504 74 -270 135 -491 135 -493 0 -1 -68 -4 -152 -5 l-152 -3%0A284 -219 c157 -121 290 -223 295 -227 7 -5 58 113 144 332 73 187 131 342 129%0A344 -2 3 -61 -29 -130 -69 l-126 -73 -47 166 c-25 91 -108 390 -183 664 -94%0A338 -143 502 -154 508 -11 6 -23 3 -37 -9z'/%3E%3C/g%3E%3C/svg%3E%0A"
    />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no"
    />

    <title>Waymark JS</title>

    <style type="text/css">
      /* Fullscreen!  */
      html,
      body {
        width: 100%;
        height: 100%;
      }
      .test-wrap {
        margin: 30px;
      }
      .app .test-wrap {
        height: 100%;
        width: 100%;
        margin: 0;
      }
    </style>
  </head>
  <body>
    <!--     <button id="clear">Clear GeoJSON</button>
    <button id="import">Import</button>
    <button id="export">Export</button> -->

    <script type="module" lang="ts">
      import maplibregl from "maplibre-gl";
      import mlcontour from "maplibre-contour";

      let MODE = "app"; // "app" | "playground"
      // MODE = "playground";
      // MODE = "docs";
      MODE = "survey";

      document.body.classList.add(MODE);
      console.clear();
      import { watch } from "vue";
      import { Instance } from "./library/main.js";

      const testIDs = ["waymark", "af-ccc", "lemiecime-it", "via-ardeche"];
      function getTestID() {
        return testIDs[Math.floor(Math.random() * testIDs.length)];
      }

      const init = async () => {
        // Playground - Multiple instances
        if (MODE === "playground") {
          const testSizes = [
            [480, 320], // Mobile landscape
            [320, 480], // Mobile portrait
            [768, 1024], // Tablet landscape
            [1024, 768], // Tablet portrait
            [1440, 900], // Desktop landscape
            [900, 1440], // Desktop portrait
          ];

          testIDs.forEach((ID, i) => {
            testSizes.forEach(async (size) => {
              // Create a div for each test data
              const div = document.createElement("div");
              div.id = "dev-" + ID + "-" + size.join("x");
              div.className = "test-wrap";
              div.style.height = `${size[1]}px`;
              div.style.width = `${size[0]}px`;
              document.body.appendChild(div);

              // Read test config (JSON)
              let testConfig = await fetch(
                `./dev/data/${ID}/devConfig.json`,
              ).then((res) => res.json());

              // Merge Object
              testConfig = Object.assign(testConfig, {
                div_id: div.id,
                units: "metric",
              });

              // Read test data (JSON)
              const testData = await fetch(
                `./dev/data/${ID}/devData.json`,
              ).then((res) => res.json());

              const instance = new Instance({
                map_options: testConfig,
              });
              instance.loadGeoJSON(testData);

              watch(instance.store.activeOverlay, (newVal) => {
                console.log(`Active Overlay Changed [${div.id}]:`, newVal);
              });
            });
          });
          // App - Single instance
        } else if (MODE === "app") {
          // Pick random test data
          let ID = getTestID();
          ID = "waymark";

          const div = document.createElement("div");
          div.id = "dev-waymark-app";
          div.className = "test-wrap";
          document.body.appendChild(div);

          // Read test config (JSON)
          let testConfig = await fetch(`./dev/data/${ID}/devConfig.json`).then(
            (res) => res.json(),
          );

          // Merge Object
          testConfig = Object.assign(testConfig, {
            div_id: div.id,
            units: "metric",
            maplibre_options: {
              // center: [45.0, 20.0],
              // zoom: 4,
              // maxZoom: 6,
              // minZoom: 2,
              // attributionControl: true,
              // logoPosition: "top-left",
              // maplibreLogo: true,
            },
          });

          // Read test data (JSON)
          const testData = await fetch(`./dev/data/${ID}/devData.json`).then(
            (res) => res.json(),
          );

          const instance = new Instance({
            map_options: testConfig,
          });
          instance.loadGeoJSON(testData);

          watch(instance.store.activeOverlay, (newVal) => {
            console.log("Active Overlay Changed:", newVal);
          });

          document
            .querySelector("button#clear")
            ?.addEventListener("click", () => {
              instance.clearGeoJSON();
            });

          document
            .querySelector("button#import")
            ?.addEventListener("click", async () => {
              // Reload from new random test data
              ID = getTestID();
              const newTestData = await fetch(
                `./dev/data/${ID}/devData.json`,
              ).then((res) => res.json());
              instance.loadGeoJSON(newTestData);
            });

          document
            .querySelector("button#export")
            ?.addEventListener("click", () => {
              const data = JSON.stringify(instance.toGeoJSON(), null, 2);
              console.log("Exported GeoJSON:", data);
              // Download the data to a file
              const blob = new Blob([data], { type: "application/json" });
              const url = URL.createObjectURL(blob);
              const a = document.createElement("a");
              a.href = url;
              a.download = "waymark-export.geojson";
              a.click();
              URL.revokeObjectURL(url);
            });
          // Docs - Single instance, no buttons
        } else if (MODE === "survey") {
          // Pick random test data
          let ID = getTestID();
          ID = "waymark";

          const div = document.createElement("div");
          div.id = "waymark-instance";
          // Set width and height for survey
          // div.style.width = "320px";
          // div.style.height = "480px";
          div.style.height = "320px";

          div.className = "test-wrap";
          document.body.appendChild(div);

          // Read test config (JSON)
          let testConfig = await fetch(`./dev/data/${ID}/devConfig.json`).then(
            (res) => res.json(),
          );

          // Merge Object
          testConfig = Object.assign(testConfig, {
            units: "metric",
            maplibre_options: {
              center: [-127.844853, 50.702166],
              // center: [-128.009734, 50.653923],
              zoom: 12.5,
              pitch: 60,
              bearing: 180,
              // maxZoom: 6,
              // minZoom: 2,
              // attributionControl: true,
              // logoPosition: "top-left",
              // maplibreLogo: true,
            },
          });

          // Read test data (JSON)
          const testData = await fetch(`./dev/data/${ID}/devData.json`).then(
            (res) => res.json(),
          );

          const instance = new Instance({
            map_options: testConfig,
          });
          instance.loadGeoJSON(testData);

          // Terrain and Contours
          instance.store.map.value.on("style.load", () => {
            instance.store.map.value.addSource("terrainSource", {
              type: "raster-dem",
              tiles: [
                "https://s3.amazonaws.com/elevation-tiles-prod/terrarium/{z}/{x}/{y}.png",
              ],
              encoding: "terrarium",
              tileSize: 256,
              maxzoom: 14,
            });

            instance.store.map.value.setTerrain({
              source: "terrainSource",
              exaggeration: 1,
            });

            instance.store.map.value.addSource("hillshadeSource", {
              type: "raster-dem",
              tiles: [
                "https://s3.amazonaws.com/elevation-tiles-prod/terrarium/{z}/{x}/{y}.png",
              ],
              encoding: "terrarium",
              tileSize: 256,
              maxzoom: 14,
            });

            instance.store.map.value.addLayer({
              id: "hillshade-layer",
              type: "hillshade",
              source: "hillshadeSource",
              paint: {
                "hillshade-shadow-color": "#333333",
              },
            });

            var demSource = new mlcontour.DemSource({
              url: "https://s3.amazonaws.com/elevation-tiles-prod/terrarium/{z}/{x}/{y}.png",
              encoding: "terrarium", // "mapbox" or "terrarium" default="terrarium"
              maxzoom: 13,
              worker: true, // offload isoline computation to a web worker to reduce jank
              cacheSize: 100, // number of most-recent tiles to cache
              timeoutMs: 10_000, // timeout on fetch requests
            });
            demSource.setupMaplibre(maplibregl);

            instance.store.map.value.addSource("contour-source", {
              type: "vector",
              minzoom: 12,
              // maxzoom: 14,
              tiles: [
                demSource.contourProtocolUrl({
                  // convert meters to feet, default=1 for meters
                  // multiplier: 3.28084,
                  thresholds: {
                    // zoom: [minor, major]
                    // We want a very subtle contour effect
                    0: [100, 500],
                    5: [50, 250],
                    10: [25, 100],
                    15: [10, 50],
                  },
                  // optional, override vector tile parameters:
                  contourLayer: "contours",
                  elevationKey: "ele",
                  levelKey: "level",
                  extent: 4096,
                  buffer: 1,
                }),
              ],
              maxzoom: 15,
            });

            instance.store.map.value.addLayer({
              id: "contour-lines",
              type: "line",
              source: "contour-source",
              "source-layer": "contours",
              paint: {
                "line-color": "rgba(0,0,0, 30%)",
                // level = highest index in thresholds array the elevation is a multiple of
                "line-width": ["match", ["get", "level"], 1, 1, 0.5],
              },
            });
            instance.store.map.value.addLayer({
              id: "contour-labels",
              type: "symbol",
              source: "contour-source",
              "source-layer": "contours",
              filter: [">", ["get", "level"], 0],
              layout: {
                "symbol-placement": "line",
                "text-size": 10,
                "text-field": [
                  "concat",
                  ["number-format", ["get", "ele"], {}],
                  "m",
                ],
                "text-font": ["Noto Sans Bold"],
              },
              paint: {
                "text-halo-color": "white",
                "text-halo-width": 1,
              },
            });
          });

          // Open the Basemap panel
          setTimeout(() => {
            instance.store.activePanelKey.value = "basemaps";
            instance.store.panelOpen.value = true;
          }, 1000);

          // Docs - Single instance, no buttons
        } else if (MODE === "docs") {
          // const div = document.createElement("div");
          // div.id = "waymark-instance";
          // div.className = "test-wrap";
          // div.style.height = "300px";
          // document.body.appendChild(div);

          // Create a Waymark Instance with this configuration
          const instance = new Instance({
            // See [Map Options](docs/v2/2.instances.md#map-options) for details
            map_options: {
              // div_id: "waymark-instance",

              // Passed directly to MapLibre GL JS
              // See [MapLibre Map Options](https://maplibre.org/maplibre-gl-js/docs/API/type-aliases/MapOptions/)
              // maplibre_options: {
              //   zoom: 16,
              // },

              // See [Marker Types](docs/v2/2.instances.md#marker-types) for details
              marker_types: [
                {
                  marker_title: "Pub",
                  marker_shape: "marker",
                  marker_size: "large",
                  icon_type: "icon",
                  marker_icon: "ion-beer",
                  marker_colour: "#fbfbfb",
                  icon_colour: "#754423",
                },
              ],
            },
          });

          //instance.map.value.setCenter([-128.0094, 50.6539]);

          // Load this GeoJSON, which contains a single "pub" Marker
          // instance.loadGeoJSON({
          //   type: "FeatureCollection",
          //   features: [
          //     {
          //       type: "Feature",
          //       properties: {
          //         type: "pub",
          //         title: "The Scarlet Ibis",
          //         description:
          //           "Great pub, great food! Especially after a Long Ride üö¥üçîüçüüç∫üç∫üí§",
          //         image_large_url:
          //           "https://www.waymark.dev/assets/geo/pub.jpeg",
          //       },
          //       geometry: {
          //         type: "Point",
          //         coordinates: [-128.0094, 50.6539],
          //       },
          //     },
          //   ],
          // });
        }
      };

      init();
    </script>
  </body>
</html>
